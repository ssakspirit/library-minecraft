name: ðŸ•·ï¸ Crawl Minecraft Education Resources

on:
  # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 3ì‹œ (UTC) ìžë™ ì‹¤í–‰
  schedule:
    - cron: '0 3 * * 0'

  # âœ… ì›í´ë¦­ ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      mode:
        description: 'í¬ë¡¤ë§ ëª¨ë“œ'
        required: true
        default: 'default'
        type: choice
        options:
          - default   # ëˆ„ë½ëœ ë°ì´í„°ë§Œ
          - retry     # ì‹¤íŒ¨í•œ ë¦¬ì†ŒìŠ¤ë§Œ
          - full      # ì „ì²´ ìž¬í¬ë¡¤ë§
      batch_size:
        description: 'í¬ë¡¤ë§ ê°œìˆ˜ (0=ì „ì²´)'
        required: false
        default: '0'
      delay:
        description: 'ìš”ì²­ ê°„ ë”œë ˆì´ (ì´ˆ)'
        required: false
        default: '5'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # ìµœëŒ€ 3ì‹œê°„

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¥ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright

      - name: ðŸŒ Install Playwright browsers
        run: |
          python -m playwright install chromium
          python -m playwright install-deps chromium

      - name: ðŸ•·ï¸ Run crawler
        run: |
          MODE="${{ github.event.inputs.mode || 'default' }}"
          BATCH="${{ github.event.inputs.batch_size || '0' }}"
          DELAY="${{ github.event.inputs.delay || '5' }}"

          CMD="python crawl.py --headless --delay $DELAY --batch $BATCH --rest-interval 15 --rest-duration 45"

          if [ "$MODE" = "full" ]; then
            CMD="$CMD --full"
          elif [ "$MODE" = "retry" ]; then
            CMD="$CMD --retry"
          fi

          echo "ðŸ•·ï¸ Running: $CMD"
          $CMD

      - name: ðŸ“Š Check for changes
        id: git-check
        run: |
          git diff --exit-code data/resources_enhanced.json || echo "changed=true" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit and push
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/resources_enhanced.json data/crawl_failed.json
          git commit -m "ðŸ¤– Auto-crawl: ${{ github.event.inputs.mode || 'default' }} mode

          Crawled Minecraft Education resources.
          Mode: ${{ github.event.inputs.mode || 'default' }}
          Batch: ${{ github.event.inputs.batch_size || '0' }}
          Delay: ${{ github.event.inputs.delay || '5' }}s"
          git push

      - name: ðŸ“Ž Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawl-logs
          path: |
            crawl.log
            data/crawl_failed.json
          retention-days: 7

      - name: ðŸ“‹ Summary
        if: always()
        run: |
          echo "## ðŸ•·ï¸ Crawl Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | \`${{ github.event.inputs.mode || 'default' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Batch | \`${{ github.event.inputs.batch_size || '0' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Delay | \`${{ github.event.inputs.delay || '5' }}s\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            echo "âœ… **Data updated and pushed to repository**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f crawl.log ]; then
            echo "### Last 20 lines of crawl.log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 crawl.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
